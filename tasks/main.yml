---
- name: packages | Fail if distro is not supported
  ansible.builtin.fail:
    msg: "Distribution '{{ ansible_facts['distribution'] }}' is not supported. Supported: Debian, Ubuntu"
  when: ansible_facts['distribution'] not in ['Debian', 'Ubuntu']

- name: packages | Include distro-specific variables
  ansible.builtin.include_vars:
    file: "{{ ansible_facts['distribution'] }}.yml"

- name: packages | Wait for dpkg lock to be released
  ansible.builtin.shell: |
    while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock >/dev/null 2>&1; do
      sleep 5
    done
  changed_when: false
  async: 300
  poll: 10

- name: packages | Ensure keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  when: packages_repositories | length > 0

- name: packages | Download repository GPG keys
  ansible.builtin.get_url:
    url: "{{ item.key_url }}"
    dest: "/etc/apt/keyrings/{{ item.filename }}.asc"
    mode: "0644"
  loop: "{{ packages_repositories }}"
  loop_control:
    label: "{{ item.filename }}"
  when: packages_repositories | length > 0

- name: packages | Add repositories with signed-by
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/{{ item.filename }}.asc] {{ item.repo }}"
    filename: "{{ item.filename }}"
    state: present
  loop: "{{ packages_repositories }}"
  loop_control:
    label: "{{ item.filename }}"
  when: packages_repositories | length > 0

- name: packages | Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ packages_cache_valid_time }}"
  when: packages_update_cache | bool

- name: packages | Full system upgrade
  ansible.builtin.apt:
    upgrade: full
    autoclean: true
    autoremove: true
  when: packages_full_upgrade | default(false) | bool

- name: packages | Install packages
  ansible.builtin.apt:
    name: "{{ packages_install_common + packages_distro_specific + packages_install_extra }}"
    state: present

- name: packages | Remove packages
  ansible.builtin.apt:
    name: "{{ packages_remove }}"
    state: absent
    purge: true
  when: packages_remove | length > 0

## Install yq (from apt if available, otherwise from GitHub)
- name: packages | Check if yq is available in apt
  ansible.builtin.shell: "apt-cache show yq 2>/dev/null | grep -q 'Package: yq'"
  register: yq_apt_available
  changed_when: false
  failed_when: false
  when: packages_yq_install | bool

- name: packages | Install yq from apt
  ansible.builtin.apt:
    name: yq
    state: present
  when:
    - packages_yq_install | bool
    - yq_apt_available.rc == 0

## Fallback: install yq from GitHub if not in apt
- name: packages | Set yq architecture
  ansible.builtin.set_fact:
    _yq_arch: "{{ 'amd64' if ansible_facts['architecture'] == 'x86_64' else 'arm64' if ansible_facts['architecture'] == 'aarch64' else ansible_facts['architecture'] }}"
  when:
    - packages_yq_install | bool
    - yq_apt_available.rc != 0

- name: packages | Check current yq version
  ansible.builtin.command: /usr/local/bin/yq --version
  register: yq_current_version
  changed_when: false
  failed_when: false
  when:
    - packages_yq_install | bool
    - yq_apt_available.rc != 0

- name: packages | Download yq from GitHub
  ansible.builtin.get_url:
    url: "https://github.com/mikefarah/yq/releases/download/{{ packages_yq_version }}/yq_linux_{{ _yq_arch }}"
    dest: /usr/local/bin/yq
    mode: "0755"
  when:
    - packages_yq_install | bool
    - yq_apt_available.rc != 0
    - packages_yq_version not in (yq_current_version.stdout | default(''))
